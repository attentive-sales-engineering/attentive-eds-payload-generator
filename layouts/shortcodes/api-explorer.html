<div class="p-2" id="{{ .Params.id }}">

  <!-- <h3>Hugo Params</h3>
  {{ range $elem_key, $elem_val := .Params }}
  <b>{{ $elem_key }}</b>: <code>{{ $elem_val }}</code><br />
  {{ end }}
  <pre>
  .Site => {{ .Site }}
  .Site.Title => {{ .Site.Title }}
  .Page => {{ .Page }}
  .Page.Title => {{ .Page.Title }}
  .Params.id => {{ .Params.id }}
  </pre> -->

  <dialog id="apiDialog">
    <form method="dialog">
      <label for="task_id">task_id:</label>
      <input name="task_id" id="task_id" ctype="text" placeholder="Enter task ID to update or blank to create new" autocomplete="off"><br>
      <label for="clientId">clientId:</label>
      <input name="clientId" id="clientId" ctype="text" placeholder="Enter client ID" autocomplete="off"><br>
      <label for="clientName">clientName:</label>
      <input name="clientName" id="clientName" ctype="text" placeholder="Enter client Name" autocomplete="off"><br>
      <label for="token">token:</label> <a id="clientIdUrl" href="https://ui.attentivemobile.com/home" target="_blank">Open Attentive UI Company account in new tab</a><br>
      <textarea name="token" id="token" cols="50" rows="4" placeholder="Paste 'attentive-auth-token' from Attentive UI Session storage"></textarea><br>
      <input id="method" type="hidden">
      <button id="apiDialogCancelBtn" type="">Cancel</button>
      <button id="apiDialogSubmitBtn" type="">Submit</button>
    </form>
  </dialog>

  <dialog id="importDialog">
    <form method="post" enctype="multipart/form-data">
      <div>
        <!-- <label class="btn btn-primary left ml-2" for="json_upload">Import File</label> -->
        <input type="file" id="json_upload" name="json_upload" accept=".json" />
      </div>
    </form>
  </dialog>

  <div data-form>
    <div class="input-group mb-3">
      <select class="form-select flex-grow-0 w-auto d-none" data-method>
        <option value="GET">GET</option>
        <option value="POST">POST</option>
        <option value="PUT">PUT</option>
        <option value="PATCH">PATCH</option>
        <option value="DELETE">DELETE</option>
      </select>
      <input data-url required class="form-control mono-url" type="url" placeholder="https://example.com" value="" />
      <!-- <button type="submit" class="btn btn-primary">Generate</button> -->
    </div>
    <ul class="nav nav-tabs" role="tablist">
      <li class="nav-item d-none" role="presentation" data-params-section>
        <button class="nav-link active" id="{{ .Params.id }}-query-params-tab" data-bs-toggle="tab" data-bs-target="#{{ .Params.id }}-query-params" type="button" role="tab" aria-controls="query-params" aria-selected="true">
          Payload
        </button>
      </li>
      <li class="nav-item d-none" role="presentation" data-user-section>
        <button class="nav-link" id="{{ .Params.id }}-request-user-tab" data-bs-toggle="tab" data-bs-target="#{{ .Params.id }}-request-user" type="button" role="tab" aria-controls="request-user" aria-selected="false">
          User
        </button>
      </li>
      <li class="nav-item" role="presentation" data-headers-section>
        <button class="nav-link" id="{{ .Params.id }}-request-headers-tab" data-bs-toggle="tab" data-bs-target="#{{ .Params.id }}-request-headers" type="button" role="tab" aria-controls="request-headers" aria-selected="false">
          Headers
        </button>
      </li>
      <li class="nav-item d-none" role="presentation" data-source-section>
        <button class="nav-link" id="{{ .Params.id }}-request-source-tab" data-bs-toggle="tab" data-bs-target="#{{ .Params.id }}-request-source" type="button" role="tab" aria-controls="request-source" aria-selected="false">
          Source
        </button>
      </li>
      <li class="nav-item d-none" role="presentation" data-schedule-section>
        <button class="nav-link" id="{{ .Params.id }}-request-schedule-tab" data-bs-toggle="tab" data-bs-target="#{{ .Params.id }}-request-schedule" type="button" role="tab" aria-controls="request-schedule" aria-selected="false">
          Schedule
        </button>
      </li>
    </ul>
    <div class="tab-content p-3 border-top-0 border">
      <div class="tab-pane fade show active" id="{{ .Params.id }}-query-params" role="tabpanel" aria-labelledby="query-params-tab">
        <div class="d-none" data-query-params-section>
          <div class="input-group">
            <div class="section-title pl-75" style="flex: 1">Params</div>
            <div class="section-title pl-75 mr-38" style="flex: 2">Column Header</div>
          </div>
          <div data-query-params></div>
          <!-- <button data-add-query-param-btn class="mt-2 btn btn-outline-success" type="button">
            &plus;
          </button> -->
        </div>
        <div class="d-none" data-props-section>
          <div class="input-group">
            <div class="section-title pl-75" style="flex: 1">Properties</div>
            <div class="section-title pl-75 mr-38" style="flex: 2">Column Header</div>
          </div>
          <div data-props></div>
          <button data-add-request-prop-btn class="mt-2 btn btn-outline-success" type="button">
            &plus;
          </button>
        </div>
        <div class="d-none" data-items-section>
          <div class="input-group">
            <div class="section-title pl-75" style="flex: 1">Items</div>
            <div class="section-title pl-75 mr-38" style="flex: 2">Column Header</div>
          </div>
          <div data-items></div>
          <!-- <button data-add-request-items-btn class="mt-2 btn btn-outline-success" type="button">
            &plus;
          </button> -->
        </div>
        <div class="d-none" data-price-section>
          <div class="input-group">
            <div class="section-title pl-75" style="flex: 1">Price</div>
            <div class="section-title pl-75 mr-38" style="flex: 2">Column Header</div>
          </div>
          <div data-price></div>
          <!-- <button data-add-request-price-btn class="mt-2 btn btn-outline-success" type="button">
            &plus;
          </button> -->
        </div>
        <div class="d-none" data-subscriptions-section>
          <div class="input-group">
            <div class="section-title pl-75" style="flex: 1">Subscriptions</div>
            <div class="section-title pl-75 mr-38" style="flex: 2">Column Header</div>
          </div>
          <div data-subscriptions></div>
          <!-- <button data-add-request-subscriptions-btn class="mt-2 btn btn-outline-success" type="button">
            &plus;
          </button> -->
        </div>
        <div class="d-none" data-json-body-section>
          <div class="section-title">JSON Body</div>
          <div class="ace-border">
            <div id="{{ .Params.id }}" class="ace-editor" data-json-body></div>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="{{ .Params.id }}-request-headers" role="tabpanel" aria-labelledby="request-headers-tab">
        <div class="" data-headers-params-section>
          <div class="input-group">
            <div class="section-title pl-75" style="flex: 1">Authorization Header</div>
            <div class="section-title pl-75 mr-38" style="flex: 2">Bearer Token</div>
          </div>
          <div data-headers></div>
          <!-- <button data-add-request-header-btn class="mt-2 btn btn-outline-success" type="button">
            &plus;
          </button> -->
        </div>
      </div>
      <div class="tab-pane fade" id="{{ .Params.id }}-request-user" role="tabpanel" aria-labelledby="request-user-tab">
        <div class="d-none" data-user-params-section>
          <div class="input-group">
            <div class="section-title pl-75" style="flex: 1">User Properties</div>
            <div class="section-title pl-75 mr-38" style="flex: 2">Column Header</div>
          </div>
          <div data-user></div>
          <button data-add-request-user-btn class="mt-2 btn btn-outline-success" type="button">
            &plus;
          </button>
        </div>
        <div class="d-none" data-user-custom-section>
          <div class="input-group">
            <div class="section-title pl-75" style="flex: 1">Custom User Identifer Properties</div>
            <div class="section-title pl-75 mr-38" style="flex: 2">Column Header</div>
          </div>
          <div data-user-custom></div>
          <!-- <button data-add-request-custom-btn class="mt-2 btn btn-outline-success" type="button">
            &plus;
          </button> -->
        </div>
      </div>
      <div class="tab-pane fade" id="{{ .Params.id }}-request-source" role="tabpanel" aria-labelledby="request-source-tab">
        <div class="d-none" data-source-params-section>
          <div class="input-group">
            <div class="section-title pl-75" style="flex: 1">Source Params</div>
            <div class="section-title pl-75 mr-38" style="flex: 2">Value</div>
          </div>
          <div data-source></div>
          <!-- <button data-add-request-source-btn class="mt-2 btn btn-outline-success" type="button">
            &plus;
          </button> -->
        </div>
      </div>
      <div class="tab-pane fade" id="{{ .Params.id }}-request-schedule" role="tabpanel" aria-labelledby="request-schedule-tab">
        <div class="d-none" data-schedule-params-section>
          <div class="input-group">
            <div class="section-title pl-75" style="flex: 1">Schedule Params</div>
            <div class="section-title pl-75 mr-38" style="flex: 2">Value</div>
          </div>
          <div data-schedule></div>
          <!-- <button data-add-request-schedule-btn class="mt-2 btn btn-outline-success" type="button">
            &plus;
          </button> -->
        </div>
      </div>
    </div>
  </div>
  <div class="" data-response-section>
    <div class="border-top-0 border p-3">
      <div class="section-title">Target Payload</div>
      <div class="ace-border">
        <div id="{{ .Params.id }}" class="ace-editor" data-target-payload></div>
      </div>
    </div>
    <div class="border-top-0 border p-3">
      <div class="section-title">Source Payload</div>
      <div class="ace-border">
        <div id="{{ .Params.id }}" class="ace-editor" data-source-payload></div>
      </div>
    </div>
    <div class="d-none border-top-0 border p-3">
      <div class="section-title">Response</div>
      <div class="d-flex my-1">
        <div class="mr-3">Status: <span data-status></span></div>
      </div>
      <div class="ace-border">
        <div id="{{ .Params.id }}" class="ace-editor" data-json-response-body></div>
      </div>
    </div>
  </div>
  <!-- The Remove button '&minus;' at end of each row -->
  <template data-key-value-template>
    <div class="input-group my-1" data-key-value-pair>
      <input type="text" data-key class="form-control" style="flex: 1" placeholder="Key" value="" />
      <input type="text" data-value class="form-control" style="flex: 2" placeholder="Value" data-curly-braces="" value="" />
      <button type="button" data-update-btn class="btn btn-outline-success curly">
        &#123;&nbsp;&#125;
      </button>
      <button type="button" data-remove-btn class="btn btn-outline-danger">
        &#10005;
      </button>
    </div>
  </template>
</div>

<script>

  // console.log("LET API PARAMS")
  let apiParams
  let url = ''
  let method = ''
  let headers = {}
  let data
  let edsPayload = {}
  let token = ''
  let task_id = ''
  let clientId = ''
  let clientName = ''
  let task_name = ''
  let task_description = ''

  async function fetchApiParams() {
    // console.log("FETCH API PARAMS")
    const searchParams = new URLSearchParams(window.location.search)
    const importParam = searchParams.get("import")
    // console.log("importParam", importParam)
    let jsonResponse
    if (importParam === 'true') {
      // console.log("IMPORT TRUE")
      // The parseImportFile function has already executed and the apiParams object has been built
      // Fetch it from localStorate and pass it to the response
      jsonResponse = JSON.parse(localStorage.getItem('apiParams'))
      // console.log("JSON RESPONSE = localStorage.getItem('apiParams')", jsonResponse)
    } else {
      // console.log("IMPORT FALSE")S
      const response = await fetch('./params.json')
      jsonResponse = await response.json()
    }
    // console.log("FETCH API PARAMS JSON RESPONSE:", jsonResponse)
    return jsonResponse
  }

  fetchApiParams()
    .then(response => {
      apiParams = response
      console.log("apiParams:", apiParams)

      if ("{{ .Params.id }}" == 'import') {
        parseImportFile("{{ .Params.id }}")
      }

      // Set url param
      document.querySelector("#{{ .Params.id }} [data-url]").value = apiParams.url

      // Set method param
      document.querySelector("#{{ .Params.id }} [data-method]").value = apiParams?.method || "GET"

      // This function renders the apiParams onscreen in rows below the appropriate sections
      function renderParams(params, paramId, tabElement, sectionElement, paramElement) {
        if (params?.length > 0) {
          document.querySelector(`#${paramId} ${tabElement}`).classList.remove("d-none")
          document.querySelector(`#${paramId} ${sectionElement}`).classList.remove("d-none")
          params?.forEach((param) => {
            document.querySelector(`#${paramId} ${paramElement}`).append(
              createKeyValuePair(
                "{{ .Params.id }}",
                param.key,
                param.value,
                param.placeholder,
                param["data-curly-braces"],
                paramElement))
          })
        }
      }

      renderParams(apiParams.queryParams, "{{ .Params.id }}", "[data-params-section]", "[data-query-params-section]", "[data-query-params]")
      renderParams(apiParams.propParams, "{{ .Params.id }}", "[data-params-section]", "[data-props-section]", "[data-props]")
      renderParams(apiParams.itemsParams, "{{ .Params.id }}", "[data-params-section]", "[data-items-section]", "[data-items]")
      renderParams(apiParams.priceParams, "{{ .Params.id }}", "[data-params-section]", "[data-price-section]", "[data-price]")
      renderParams(apiParams.subscriptionsParams, "{{ .Params.id }}", "[data-params-section]", "[data-subscriptions-section]", "[data-subscriptions]")
      renderParams(apiParams.headerParams, "{{ .Params.id }}", "[data-headers-section]", "[data-headers-params-section]", "[data-headers]")
      renderParams(apiParams.userParams, "{{ .Params.id }}", "[data-user-section]", "[data-user-params-section]", "[data-user]")
      renderParams(apiParams.customParams, "{{ .Params.id }}", "[data-user-section]", "[data-user-custom-section]", "[data-user-custom]")
      renderParams(apiParams.sourceParams, "{{ .Params.id }}", "[data-source-section]", "[data-source-params-section]", "[data-source]")
      renderParams(apiParams.scheduleParams, "{{ .Params.id }}", "[data-schedule-section]", "[data-schedule-params-section]", "[data-schedule]")

      // // If JSON Params, unhide & set textContent
      // // Not currently used, but may use it for the Product Catalog payloads
      // if (typeof apiParams.jsonParams != "undefined") {
      //   // console.log("JSON PARAMS:", apiParams.jsonParams)
      //   jsonString = JSON.stringify(apiParams.jsonParams, null, 2)
      //   // console.log(jsonString)
      //   // console.log(jsonString.length)
      //   if (jsonString.length > 2) {
      //     document.querySelector("#{{ .Params.id }} [data-json-body]").textContent = jsonString
      //     document.querySelector("#{{ .Params.id }} [data-params-section]").classList.remove("d-none")
      //     document.querySelector("#{{ .Params.id }} [data-json-body-section]").classList.remove("d-none")

      //     // JSON Body Editor - Ace Code Editor for the Web
      //     editor = ace.edit(document.querySelector("#{{ .Params.id }} [data-json-body]"))
      //     editor.setTheme("ace/theme/monokai")
      //     editor.session.setMode("ace/mode/json")
      //     editor.setOptions({
      //       "maxLines": Infinity,
      //       "highlightActiveLine": false,
      //       "showLineNumbers": false,
      //       "showGutter": false,
      //       "showPrintMargin": false,
      //       "fontSize": 14
      //     })
      //   }
      // }

    })

  // ADD ROWS
  // Add new key/value row onscreen when the Plus button is clicked
  function addRow(paramId, btnElement, dataElement) {
    // console.log("ADD ROW:", paramId)
    document.querySelector(`#${paramId} ${btnElement}`).addEventListener("click", () => {
      document.querySelector(`#${paramId} ${dataElement}`).append(
        createKeyValuePair(`${paramId}`)
      )
    })
  }

  addRow("{{ .Params.id }}", "[data-add-request-prop-btn]", "[data-props]")
  // addRow("{{ .Params.id }}", "[data-add-request-items-btn]", "[data-items]")
  // addRow("{{ .Params.id }}", "[data-add-request-price-btn]", "[data-price]")
  // addRow("{{ .Params.id }}", "[data-add-request-subscriptions-btn]", "[data-subscriptions]")
  // addRow("{{ .Params.id }}", "[data-add-query-param-btn]", "[data-query-params]")
  // addRow("{{ .Params.id }}", "[data-add-request-header-btn]", "[data-headers]")
  addRow("{{ .Params.id }}", "[data-add-request-user-btn]", "[data-user]")
  // addRow("{{ .Params.id }}", "[data-add-request-custom-btn]", "[data-user-custom]")
  // addRow("{{ .Params.id }}", "[data-add-request-source-btn]", "[data-source]")
  // addRow("{{ .Params.id }}", "[data-add-request-schedule-btn]", "[data-schedule]")


  // NAV LINKS
  // Nav link click listeners
  document.querySelectorAll('a.gdoc-nav__entry').forEach(element => {
    // console.log("ELEMENT:", element)
    element.addEventListener("click", e => {
      // console.log("CLICK E:", e)
      const path = new URL(e.srcElement.href).pathname
      // SOW Link
      if (path.includes("/sow")) {
        e.preventDefault()
        console.log("CLICKED SOW LINK")
        localStorage.setItem("eds-sow", JSON.stringify(edsPayload))
        window.open("../../tools/sow", '_blank')
      } else if (path.includes("/export")) {
        console.log("CLICKED EXPORT LINK")
        exportJson(e.srcElement)
      } else if (path.includes("/import")) {
        console.log("CLICKED IMPORT LINK")
        e.preventDefault()
        importDialog.showModal()
        // importJson()
      } else if (path.includes("/create")) {
        e.preventDefault()
        console.log("CLICKED CREATE LINK")
        window.open("https://ui.attentivemobile.com/tactical/event-destinations/create?companyId=" + edsPayload.clientPayload.clientId, '_blank')
      } else if (path.includes("/view")) {
        e.preventDefault()
        console.log("CLICKED VIEW LINK")
        window.open("https://ui.attentivemobile.com/tactical/event-destinations/jobs/" + edsPayload.task_id, '_blank')
      } else if (path.match(/get|post/)) {
        e.preventDefault()
        if (edsPayload.task_id) task_id = edsPayload.task_id
        if (edsPayload.clientPayload.clientId) clientId = edsPayload.clientPayload.clientId
        if (edsPayload.clientPayload.clientName) clientName = edsPayload.clientPayload.clientName
        console.log("TASK ID:", task_id)
        console.log("CLIENT ID:", clientId)
        console.log("CLIENT NAME:", clientName)
        apiDialog.querySelector("#task_id").value = task_id
        apiDialog.querySelector("#clientId").value = clientId
        apiDialog.querySelector("#clientName").value = clientName
        if (path.includes("/get")) {
          console.log("CLICKED GET PAYLOAD")
          apiDialog.querySelector("#method").value = "GET"
          apiDialog.querySelector("#task_id").placeholder = "Enter task_id of job to fetch"
        } else if (path.includes("/post")) {
          console.log("CLICKED POST PAYLOAD")
          createFileName()
          if (filename != 'data') task_name = filename
          console.log("TASK NAME:", task_name)
          apiDialog.querySelector("#method").value = "POST"
          apiDialog.querySelector("#task_id").placeholder = "Enter task_id to update or blank to create new"
        }
        apiDialog.showModal()
      }
    })
  })

  let filename = ''
  function createFileName() {
    console.log("filename BEFORE:", filename)
    filename = ''
    console.log("filename RESET:", filename)
    if (edsPayload.clientPayload["ticketUrl"] && edsPayload.clientPayload["ticketUrl"].length > 0 && edsPayload.clientPayload["ticketUrl"].match(/\d+$/)) {
      filename += `EDS-${edsPayload.clientPayload["ticketUrl"].match(/\d+$/).toString()}: `
    }
    if (edsPayload.clientPayload["clientName"] && edsPayload.clientPayload["clientName"].length > 0) {
      filename += `${edsPayload.clientPayload["clientName"]} `
    }
    console.log("edsPayload.request_details.url:", edsPayload.request_details.url)
    let apiFileName = getApiFromUrl(edsPayload.request_details.url)
    console.log("apiFileName:", apiFileName)

    filename += `${apiFileName.name}`
    if (filename === null || filename === '') filename = 'data'
    console.log("filename:", filename)
  }

  // EXPORT
  // Export edsPayload json
  function exportJson(element) {
    // console.log("exportJson() function")
    const data = "text/json;charset=utf-8;filename=foo," + encodeURIComponent(JSON.stringify(edsPayload))
    const downloadBtn = element
    downloadBtn.href = 'data:' + data
    // console.log("downloadBtn:", downloadBtn)
    createFileName()
    downloadBtn.download = `${filename}.json`
  }

  // IMPORT
  // Import button click listener
  const importElement = document.querySelector("#json_upload")
  // importElement.style.display = "contents"
  // importElement.style.opacity = 0
  importElement.addEventListener("change", importJson)

  // Import json file and save to local storage
  function importJson() {
    console.log("IMPORT JSON")
    const files = importElement.files
    // console.log("FILES:", files)
    let jsonFile
    if (files.length > 0) {
      jsonFile = importElement.files[0]
    }
    const reader = new FileReader()
    reader.onload = function (e) {
      const text = e.target.result
      localStorage.setItem("eds-import", text)
      window.location.href = "../../tools/import"
    }
    reader.readAsText(jsonFile)
  }

  // MODAL DIALOGS
  // Display apiDialog then trigger axios request
  const apiDialog = document.querySelector("#apiDialog")
  closeDialog(apiDialog)

  // Display Import Dialog then trigger importJson
  const importDialog = document.querySelector("#importDialog")
  closeDialog(importDialog)

  // Listener function for closing the dialog when clicked outside its dimensions
  function closeDialog(dialog) {
    dialog.addEventListener("click", e => {
      const dialogDimensions = dialog.getBoundingClientRect()
      if (
        e.clientX < dialogDimensions.left ||
        e.clientX > dialogDimensions.right ||
        e.clientY < dialogDimensions.top ||
        e.clientY > dialogDimensions.bottom
      ) {
        dialog.close()
      }
    })
  }

  // Open Attentive UI with ?companyId=x in new window
  apiDialog.querySelector("#clientIdUrl").addEventListener("click", (e) => {
    e.preventDefault()
    console.log("CLICKED CID URL", e)
    // console.log("CLICKED CID URL srcElement.href", e.srcElement.href)
    const companyId = document.querySelector("#clientId").value
    console.log("companyId", companyId)
    window.open("https://ui.attentivemobile.com/home" + "?companyId=" + companyId, "_blank")
  })

  // Dialog submit button event listener
  // Capture task_id and token and trigger axios request
  apiDialog.querySelector("#apiDialogSubmitBtn").addEventListener("click", () => {
    console.log("#apiDialogSubmitBtn click:")
    token = document.querySelector("#token").value
    console.log("TOKEN:", token)
    task_id = document.querySelector("#task_id").value
    console.log("task_id:", task_id)
    clientId = document.querySelector("#clientId").value
    console.log("clientId:", clientId)
    clientName = document.querySelector("#clientName").value
    console.log("clientName:", clientName)
    console.log("TASK ID VALUE", task_id)
    method = document.querySelector("#method").value
    headers['Authorization'] = `Bearer ${token}`
    if (!token) {
      alert("You must enter an attentive-auth-token")
      return
    }
    const grantsTokenString = token.split('.')[1]
    if (!grantsTokenString) {
      alert("Invalid token")
      return
    } else {
      console.log("grantsTokenString:", grantsTokenString)
      const grants = JSON.parse(atob(grantsTokenString))
      console.log("grants:", grants)
      const selectedCompanyId = grants.data.selectedCompanyId
      console.log("selectedCompanyId:", selectedCompanyId)
      if (clientId != selectedCompanyId) {
        alert("Wrong token for this client ID!")
        return
      }
    }
    if (method === "POST") {
      url = "https://johnchaffee.ngrok.io/v1/event-destination/post-mapping"
      edsPayload.task_id = task_id
      data = edsPayload
      headers['content-type'] = 'application/json'
    } else {
      console.log("GET")
      url = "https://johnchaffee.ngrok.io/v1/event-destination/get-mapping/" + task_id
    }
    console.log("=====")
    console.log('URL:', url)
    console.log('METHOD:', method)
    console.log('HEADERS:', headers)
    console.log('DATA:', data)
    console.log("=====")

    if (task_id) {
      // Have task_id, do a POST or GET to update or fecth existing task
      console.log("if task_id:", task_id)
      edsMapping()
    } else {
      // No task_id
      console.log("No task_id:", task_id)
      if (method === "POST") {
        // Create new task, then call edsMapping
        if (task_name === '' || !edsPayload.clientPayload["clientName"] || edsPayload.clientPayload["clientName"].length == 0) {
          alert("You must enter a clientName in the Source tab")
        } else {
          createTask()
        }
      } else {
        // Can't do a GET with no task_id
        alert("You must enter a task ID")
      }
    }
  })

  // AXIOS REQUESTS
  // GET or POST mapping for existing task_id
  async function edsMapping() {
    console.log("axios edsMapping")
    console.log("axios edsMapping task_id:", task_id)
    axios({
      url,
      method,
      headers,
      data
    })
      .then(function (response) {
        // handle success
        console.log('SUCCESS')
        console.log('RESPONSE.DATA:', response.data)
        console.log("METHOD:", method)
        if (method === "POST") {
          // Open EDS Job in new window
          window.open("https://ui.attentivemobile.com/tactical/event-destinations/jobs/" + task_id, '_blank')
        } else {
          // Must be a GET, store response in local storage and redirect to import page
          localStorage.setItem("eds-import", JSON.stringify(response.data))
          window.location.href = "../../tools/import"
        }
      })
      .catch(function (error) {
        console.log('CATCH')
        if (error.response) {
          console.log("ERROR.RESPONSE")
          // The request was made and the server responded with a status code
          // that falls out of the range of 2xx
          console.log("ERROR.toJSON().STATUS:", error.toJSON().status)
          console.log("ERROR.toJSON().CODE:", error.toJSON().code)
          console.log("ERROR.toJSON().MESSAGE:", error.toJSON().message)
          alert(error.toJSON().message)
          // console.log("ERROR.toJSON:", error.toJSON())
          // console.log("ERROR.CONFIG", error.config)
        } else if (error.request) {
          console.log("ERROR.REQUEST")
          // The request was made but no response was received
          // `error.request` is an instance of XMLHttpRequest in the browser and an instance of
          // http.ClientRequest in node.js
          console.log(error.request)
          alert(error.request)
        } else {
          console.log("ERROR.MESSAGE")
          // Something happened in setting up the request that triggered an Error
          console.log('Error', error.message)
          alert(error.request)
        }
      })
      .finally(function () {
        // always executed
        console.log('FINALLY')
      })
  }

  // Create new task, then create edsMapping
  async function createTask() {
    console.log("axios createTask")
    axios({
      url: "https://johnchaffee.ngrok.io/v1/event-destination/create-task",
      method,
      headers,
      data: {
        "task_name": task_name,
        "task_description": task_description
      }
    })
      .then(function (response) {
        // handle success
        console.log('SUCCESS')
        console.log('RESPONSE.DATA:', response.data)
        console.log("METHOD:", method)
        task_id = response.data.task_id
        edsPayload.task_id = task_id
        // edsPayload.clientPayload.taskUrl = "https://ui.attentivemobile.com/tactical/event-destinations/jobs/" + task_id
        // apiParams.sourceParams.taskUrl = "https://ui.attentivemobile.com/tactical/event-destinations/jobs/" + task_id
        edsMapping()
      })
      .catch(function (error) {
        console.log('CATCH')
        if (error.response) {
          console.log("ERROR.RESPONSE")
          // The request was made and the server responded with a status code
          // that falls out of the range of 2xx
          console.log("ERROR.toJSON().STATUS:", error.toJSON().status)
          console.log("ERROR.toJSON().CODE:", error.toJSON().code)
          console.log("ERROR.toJSON().MESSAGE:", error.toJSON().message)
          alert(error.toJSON().message)
          // console.log("ERROR.toJSON:", error.toJSON())
          // console.log("ERROR.CONFIG", error.config)
        } else if (error.request) {
          console.log("ERROR.REQUEST")
          // The request was made but no response was received
          // `error.request` is an instance of XMLHttpRequest in the browser and an instance of
          // http.ClientRequest in node.js
          console.log(error.request)
          alert(error.request)
        } else {
          console.log("ERROR.MESSAGE")
          // Something happened in setting up the request that triggered an Error
          console.log('Error', error.message)
          alert(error.message)
        }
      })
      .finally(function () {
        // always executed
        console.log('FINALLY')
      })
  }

  // UPDATE PAYLAOD LISTENERS
  document.addEventListener("readystatechange", function (e) {
    if (e.target.readyState === "complete") {
      console.log("readystatechange === complete")
      updatePayload(e, "{{ .Params.id }}")
    }
  })
  document.querySelector("[data-form]").addEventListener('keyup', function (e) {
    updatePayload(e, "{{ .Params.id }}")
  })
  document.querySelector("[data-form]").addEventListener('click', function (e) {
    updatePayload(e, "{{ .Params.id }}")
  })

</script>