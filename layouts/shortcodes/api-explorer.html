<div class="p-2" id="{{ .Params.id }}">

  <!-- Load apiParams from file -->
  <!-- <script await src="{{ .Params.file }}"></script> -->

  <!-- <script>
    console.log("API PARAMS: {{ .Params.file }}", apiParams)
  </script> -->

  <!-- <h3>Hugo Params</h3>
  {{ range $elem_key, $elem_val := .Params }}
  <b>{{ $elem_key }}</b>: <code>{{ $elem_val }}</code><br />
  {{ end }}

  <pre>
  .Site => {{ .Site }}
  .Site.Title => {{ .Site.Title }}
  .Page => {{ .Page }}
  .Page.Title => {{ .Page.Title }}
  .Params.id => {{ .Params.id }}
  .Params.file => {{ .Params.file }}
  </pre> -->

  <div class="mt-x">
    <a id="downloadBtn" href=""><button type="submit" class="btn btn-primary right ml-2 mb-4"
        export-btn>Export</button></a>
    <form method="post" enctype="multipart/form-data">
      <div>
        <label class="btn btn-primary right" for="json_upload">Import</label>
        <input type="file" id="json_upload" name="json_upload" accept=".json" />
      </div>
    </form>
  </div>
  <div data-form>
    <div class="input-group mb-3">
      <select class="form-select flex-grow-0 w-auto d-none" data-method>
        <option value="GET">GET</option>
        <option value="POST">POST</option>
        <option value="PUT">PUT</option>
        <option value="PATCH">PATCH</option>
        <option value="DELETE">DELETE</option>
      </select>
      <input data-url required class="form-control mono-url" type="url" placeholder="https://example.com" value="" />
      <!-- <button type="submit" class="btn btn-primary">Generate</button> -->
    </div>
    <ul class="nav nav-tabs" role="tablist">
      <li class="nav-item d-none" role="presentation" data-source-section>
        <button class="nav-link active" id="{{ .Params.id }}-request-source-tab" data-bs-toggle="tab"
          data-bs-target="#{{ .Params.id }}-request-source" type="button" role="tab" aria-controls="request-source"
          aria-selected="false">
          Source
        </button>
      </li>
      <li class="nav-item d-none" role="presentation" data-params-section>
        <button class="nav-link" id="{{ .Params.id }}-query-params-tab" data-bs-toggle="tab"
          data-bs-target="#{{ .Params.id }}-query-params" type="button" role="tab" aria-controls="query-params"
          aria-selected="true">
          Payload
        </button>
      </li>
      <li class="nav-item d-none" role="presentation" data-user-section>
        <button class="nav-link" id="{{ .Params.id }}-request-user-tab" data-bs-toggle="tab"
          data-bs-target="#{{ .Params.id }}-request-user" type="button" role="tab" aria-controls="request-user"
          aria-selected="false">
          User
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="{{ .Params.id }}-request-headers-tab" data-bs-toggle="tab"
          data-bs-target="#{{ .Params.id }}-request-headers" type="button" role="tab" aria-controls="request-headers"
          aria-selected="false">
          Headers
        </button>
      </li>
    </ul>
    <div class="tab-content p-3 border-top-0 border">
      <div class="tab-pane fade" id="{{ .Params.id }}-query-params" role="tabpanel" aria-labelledby="query-params-tab">
        <div class="d-none" data-query-params-section>
          <div class="input-group">
            <div class="section-title pl-75" style="flex: 1">Params</div>
            <div class="section-title pl-75 mr-38" style="flex: 2">Column Header</div>
          </div>
          <div data-query-params></div>
          <!-- <button data-add-query-param-btn class="mt-2 btn btn-outline-success" type="button">
            &plus;
          </button> -->
        </div>
        <div class="d-none" data-props-section>
          <div class="input-group">
            <div class="section-title pl-75" style="flex: 1">Properties</div>
            <div class="section-title pl-75 mr-38" style="flex: 2">Column Header</div>
          </div>
          <div data-props></div>
          <button data-add-request-prop-btn class="mt-2 btn btn-outline-success" type="button">
            &plus;
          </button>
        </div>
        <div class="d-none" data-items-section>
          <div class="input-group">
            <div class="section-title pl-75" style="flex: 1">Items</div>
            <div class="section-title pl-75 mr-38" style="flex: 2">Column Header</div>
          </div>
          <div data-items></div>
          <!-- <button data-add-request-items-btn class="mt-2 btn btn-outline-success" type="button">
            &plus;
          </button> -->
        </div>
        <div class="d-none" data-price-section>
          <div class="input-group">
            <div class="section-title pl-75" style="flex: 1">Price</div>
            <div class="section-title pl-75 mr-38" style="flex: 2">Column Header</div>
          </div>
          <div data-price></div>
          <!-- <button data-add-request-price-btn class="mt-2 btn btn-outline-success" type="button">
            &plus;
          </button> -->
        </div>
        <div class="d-none" data-subscriptions-section>
          <div class="input-group">
            <div class="section-title pl-75" style="flex: 1">Subscriptions</div>
            <div class="section-title pl-75 mr-38" style="flex: 2">Column Header</div>
          </div>
          <div data-subscriptions></div>
          <!-- <button data-add-request-subscriptions-btn class="mt-2 btn btn-outline-success" type="button">
            &plus;
          </button> -->
        </div>
        <div class="d-none" data-json-body-section>
          <div class="section-title">JSON Body</div>
          <div class="ace-border">
            <div id="{{ .Params.id }}" class="ace-editor" data-json-body></div>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="{{ .Params.id }}-request-headers" role="tabpanel"
        aria-labelledby="request-headers-tab">
        <div class="" data-request-headers-section>
          <div class="input-group">
            <div class="section-title pl-75" style="flex: 1">Authorization Header</div>
            <div class="section-title pl-75 mr-38" style="flex: 2">Bearer Token</div>
          </div>
          <div data-request-headers></div>
          <button data-add-request-header-btn class="mt-2 btn btn-outline-success" type="button">
            &plus;
          </button>
        </div>
      </div>
      <div class="tab-pane fade" id="{{ .Params.id }}-request-user" role="tabpanel" aria-labelledby="request-user-tab">
        <div class="d-none" data-user-params-section>
          <div class="input-group">
            <div class="section-title pl-75" style="flex: 1">User Properties</div>
            <div class="section-title pl-75 mr-38" style="flex: 2">Column Header</div>
          </div>
          <div data-user></div>
          <button data-add-request-user-btn class="mt-2 btn btn-outline-success" type="button">
            &plus;
          </button>
        </div>
        <div class="d-none" data-user-custom-section>
          <div class="input-group">
            <div class="section-title pl-75" style="flex: 1">Custom User Identifer Properties</div>
            <div class="section-title pl-75 mr-38" style="flex: 2">Column Header</div>
          </div>
          <div data-user-custom></div>
          <!-- <button data-add-request-custom-btn class="mt-2 btn btn-outline-success" type="button">
            &plus;
          </button> -->
        </div>
      </div>
      <div class="tab-pane fade show active" id="{{ .Params.id }}-request-source" role="tabpanel"
        aria-labelledby="request-source-tab">
        <div class="input-group">
          <div class="section-title pl-75" style="flex: 1">Source Params</div>
          <div class="section-title pl-75 mr-38" style="flex: 2">Column Header</div>
        </div>
        <div data-source></div>
        <!-- <button data-add-request-source-btn class="mt-2 btn btn-outline-success" type="button">
          &plus;
        </button> -->
      </div>
    </div>
  </div>
  <div class="" data-response-section>
    <div class="border-top-0 border p-3">
      <div class="section-title">Source Payload</div>
      <div class="ace-border">
        <div id="{{ .Params.id }}" class="ace-editor" data-source-payload></div>
      </div>
    </div>
    <div class="border-top-0 border p-3">
      <div class="section-title">Target Payload</div>
      <div class="ace-border">
        <div id="{{ .Params.id }}" class="ace-editor" data-target-payload></div>
      </div>
    </div>
    <div class="d-none border-top-0 border p-3">
      <div class="section-title">Response</div>
      <div class="d-flex my-1">
        <div class="mr-3">Status: <span data-status></span></div>
      </div>
      <div class="ace-border">
        <div id="{{ .Params.id }}" class="ace-editor" data-json-response-body></div>
      </div>
    </div>
  </div>
  <!-- The Remove button '&minus;' at end of each row -->
  <template data-key-value-template>
    <div class="input-group my-1" data-key-value-pair>
      <input type="text" data-key class="form-control" style="flex: 1" placeholder="Key" value="" />
      <input type="text" data-value class="form-control" style="flex: 2" placeholder="Value" value="" />
      <button type="button" data-update-btn class="btn btn-outline-success d-none">
        &#9998;
      </button>
      <button type="button" data-remove-btn class="btn btn-outline-danger">
        &#10005;
      </button>
    </div>
  </template>
</div>

<script>

  async function fetchApiParams() {
    if ("{{ .Params.id }}" == 'custom') {

      let apiParams = {
        url: '',
        method: '',
        sourceParams: [
          {
            key: 'clientName',
            value: '',
            placeholder: 'Chafco (required)'
          },
          {
            key: 'clientId',
            value: '',
            placeholder: '83006 (required)'
          },
          {
            key: 'fileName',
            value: '',
            placeholder: 'chafco/uploads/custom_attributes.csv (required)'
          },
          {
            key: 'delimiter',
            value: '',
            placeholder: 'comma, tab, pipe, ndjson (optional, default comma)'
          },
          {
            key: 'dateFormat',
            value: '',
            placeholder: 'yyyyMMdd, yyyyMMddHH00 (required, if scheduled)'
          },
          {
            key: 'timeZone',
            value: '',
            placeholder: 'America/New_York, Europe/London (required, if scheduled)'
          }
        ],
        propParams: [],
        itemsParams: [],
        priceParams: [],
        queryParams: [],
        jsonParams: {},
        headerParams: [],
        userParams: [
          {
            key: 'phone',
            value: '',
            placeholder: 'phone (required, E.164 format)'
          },
          {
            key: 'email',
            value: '',
            placeholder: 'email (phone or email required)'
          },
          {
            key: 'externalIdentifiers.clientUserId',
            value: '',
            placeholder: 'clientUserId (optional)'
          }
        ],
        customParams: []
      }

      console.log("CUSTOM")
      console.log("API PARAMS BEFORE:", apiParams)

      const importFile = JSON.parse(localStorage.getItem("import"))
      console.log("IMPORT OBJECT:", importFile)

      // apiParams = importFile
      const custom = apiParams
      console.log("CUSTOM:", custom)
      const target = importFile.targetPayload
      console.log("TARGET:", target)
      const source = importFile.sourcePayload
      console.log("SOURCE:", source)
      const client = importFile.clientPayload
      console.log("CLIENT:", client)

      function createParams(paramName, myObject, myParams) {
        // console.log('paramName', paramName)
        Object.entries(myParams).forEach(entry => {
          const [key, value] = entry
          // console.log(`PROP ${key}: ${value}`)
          if (paramName === 'queryParams') {
            if (
              `${key}` === 'properties' ||
              `${key}` === 'items' ||
              `${key}` === 'user'
            ) {
              return
            }
          }

          let val = value
          if (key != "Authorization") {
            val = val.slice(2, -2)
          }

          const thisObj = {
            key: key,
            value: val,
            placeholder: ''
          }

          myObject.push(thisObj)
        })
      }

      custom.url = target.url
      custom.method = target.method
      // const props = target.payload_mapping.properties
      // custom.propParams[0] = target.payload_mapping.properties

      // propParams
      if (target.payload_mapping.properties) {
        createParams('propParams', custom.propParams, target.payload_mapping.properties)
      }

      // priceParams
      if (target.payload_mapping.items && target.payload_mapping.items[0].price[0]) {
        createParams(
          'priceParams',
          custom.priceParams,
          target.payload_mapping.items[0].price[0]
        )
      }

      // itemsParams
      if (target.payload_mapping.items) {
        createParams('itemsParams', custom.itemsParams, target.payload_mapping.items[0])
        custom.itemsParams.splice(6, 1)
      }

      // headerParams
      if (target.header_mapping) {
        createParams('headerParams', custom.headerParams, target.header_mapping)
      }

      // userParams
      if (target.payload_mapping.user.externalIdentifiers.clientUserId) {
        // custom.log('externalIdentifiers.clientUserId')
        custom.userParams[2].value =
          target.payload_mapping.user.externalIdentifiers.clientUserId.slice(2, -2)
      } else {
        // custom.log('DELETE externalIdentifiers.clientUserId')
        custom.userParams.splice(2, 1)
      }
      if (target.payload_mapping.user.email) {
        // custom.log('EMAIL')
        custom.userParams[1].value = target.payload_mapping.user.email.slice(2, -2)
      } else {
        // custom.log('DELETE email')
        custom.userParams.splice(1, 1)
      }
      if (target.payload_mapping.user.phone) {
        // custom.log('PHONE')
        custom.userParams[0].value = target.payload_mapping.user.phone.slice(2, -2)
      } else {
        // custom.log('DELETE phone')
        custom.userParams.splice(0, 1)
      }
      // custom.customParams = target.payload_mapping.user.externalIdentifiers.custom

      // customParams
      if (target.payload_mapping.user.externalIdentifiers.custom[0]) {
        createParams(
          'customParams',
          custom.customParams,
          target.payload_mapping.user.externalIdentifiers.custom[0]
        )
      }

      // queryParams
      if (target.payload_mapping) {
        createParams('queryParams', custom.queryParams, target.payload_mapping)
      }

      // sourceParams
      const key_name = source.key_name
      let dateFormat = key_name.match(/\[\[\w+\]\]/)
      if (dateFormat) {
        dateFormat = dateFormat.toString().replace('[[', '').replace(']]', '')
      }
      let timeZone = key_name.match(/<&\S+&>/)
      if (timeZone) {
        timeZone = timeZone.toString().replace('<&', '').replace('&>', '')
      }
      let fileName = key_name.replace(/\[\[\w+\]\]/, '').replace(/<&\S+&>/, '')
      custom.sourceParams[0].value = client.clientName
        ? client.clientName
        : ''
      custom.sourceParams[1].value = client.clientId
        ? client.clientId
        : ''
      custom.sourceParams[2].value = fileName
      custom.sourceParams[3].value = source.delimiter
        ? source.delimiter
        : ''
      custom.sourceParams[4].value = dateFormat
      custom.sourceParams[5].value = timeZone

      console.log('CUSTOM AT END:', custom)
      apiParams = custom
      console.log('apiParams AFTER:', apiParams)
      // console.log('edsPayload:', JSON.stringify(edsPayload, null, 2))

      // console.log('custom:', JSON.stringify(custom, null, 2))
      return apiParams

    } else {
      const response = await fetch('./params/params.json')
      const jsonResponse = await response.json()
      console.log("ASYNC FETCH:", jsonResponse)
      return jsonResponse
    }
  }


  fetchApiParams()
    .then(response => {
      console.log("THEN FETCH:", response)
      const apiParams = response

      // Export button click listener
      document.querySelector("#{{ .Params.id }} [export-btn]").addEventListener("click", () => {
        const data = "text/json;charset=utf-8;filename=foo," + encodeURIComponent(JSON.stringify(edsPayload))
        const downloadBtn = document.getElementById("downloadBtn")
        downloadBtn.href = 'data:' + data
        let filename = "EDS Payload"
        if (edsPayload.sourcePayload["key_name"].length > 0) {
          filename += ` ${edsPayload.sourcePayload["key_name"].replace(/(\.\w*)/, '').replace(/\[.*/, '').replace(/\<&.*/, '')}`
        }
        if (filename === null || filename === '') filename = 'data'
        downloadBtn.download = `${filename}.json`
      })

      // Import button click listener
      const input = document.querySelector("#json_upload")
      input.style.opacity = 0
      input.addEventListener("change", importJson)

      function importJson() {
        console.log("CHANGE")
        const files = input.files
        console.log("FILES.LENGTH:", input.files.length)
        let jsonFile
        if (files.length > 0) {
          jsonFile = input.files[0]
          console.log("files[0]:", files[0])
        }
        const reader = new FileReader()
        reader.onload = function (e) {
          const text = e.target.result
          console.log("TEXT:", text)
          const stringify = JSON.stringify(text)
          console.log("STRINGIFY:", stringify)
          const parsed = JSON.parse(stringify)
          console.log("PARSED:", parsed)
          localStorage.setItem("import", text)
          const getItem = localStorage.getItem("import")
          console.log("GET ITEM:", getItem)
          window.location.href = "../custom"
        }
        reader.readAsText(jsonFile)
      }

      // Add query params Add button click listener
      document.querySelector("#{{ .Params.id }} [data-add-request-prop-btn]").addEventListener("click", () => {
        document.querySelector("#{{ .Params.id }} [data-props]").append(
          createKeyValuePair("{{ .Params.id }}")
        )
      })

      // // Add Items params Add button click listener
      // document.querySelector("#{{ .Params.id }} [data-add-request-items-btn]").addEventListener("click", () => {
      //   document.querySelector("#{{ .Params.id }} [data-items]").append(
      //     createKeyValuePair("{{ .Params.id }}")
      //   )
      // })

      // // Add Price params Add button click listener
      // document.querySelector("#{{ .Params.id }} [data-add-request-price-btn]").addEventListener("click", () => {
      //   document.querySelector("#{{ .Params.id }} [data-price]").append(
      //     createKeyValuePair("{{ .Params.id }}")
      //   )
      // })

      // // Add Subscriptions params Add button click listener
      // document.querySelector("#{{ .Params.id }} [data-add-request-subscriptions-btn]").addEventListener("click", () => {
      //   document.querySelector("#{{ .Params.id }} [data-subscriptions]").append(
      //     createKeyValuePair("{{ .Params.id }}")
      //   )
      // })

      // // Add query params Add button click listener
      // document.querySelector("#{{ .Params.id }} [data-add-query-param-btn]").addEventListener("click", () => {
      //   document.querySelector("#{{ .Params.id }} [data-query-params]").append(
      //     createKeyValuePair("{{ .Params.id }}")
      //   )
      // })

      // Add header params Add button click listener
      document.querySelector("#{{ .Params.id }} [data-add-request-header-btn]").addEventListener("click", () => {
        document.querySelector("#{{ .Params.id }} [data-request-headers]").append(
          createKeyValuePair("{{ .Params.id }}")
        )
      })

      // Add User params Add button click listener
      document.querySelector("#{{ .Params.id }} [data-add-request-user-btn]").addEventListener("click", () => {
        document.querySelector("#{{ .Params.id }} [data-user]").append(
          createKeyValuePair("{{ .Params.id }}")
        )
      })

      // // Add Custom Identifier params Add button click listener
      // document.querySelector("#{{ .Params.id }} [data-add-request-custom-btn]").addEventListener("click", () => {
      //   document.querySelector("#{{ .Params.id }} [data-user-custom]").append(
      //     createKeyValuePair("{{ .Params.id }}")
      //   )
      // })

      // // Add Source params Add button click listener
      // document.querySelector("#{{ .Params.id }} [data-add-request-source-btn]").addEventListener("click", () => {
      //   document.querySelector("#{{ .Params.id }} [data-source]").append(
      //     createKeyValuePair("{{ .Params.id }}")
      //   )
      // })

      // Set url param
      document.querySelector("#{{ .Params.id }} [data-url]").value = apiParams.url

      // Set method param
      document.querySelector("#{{ .Params.id }} [data-method]").value = apiParams?.method || "GET"

      // If Query Params, unhide & append key value pairs
      if (apiParams.queryParams?.length > 0) {
        document.querySelector("#{{ .Params.id }} [data-params-section]").classList.remove("d-none")
        document.querySelector("#{{ .Params.id }} [data-query-params-section]").classList.remove("d-none")
        apiParams.queryParams?.forEach((queryParam) => {
          document.querySelector("#{{ .Params.id }} [data-query-params]").append(
            createKeyValuePair(
              "{{ .Params.id }}",
              queryParam.key,
              queryParam.value,
              queryParam.placeholder)
          )
        })
      }

      // If Property Params, unhide & append key value pairs
      if (apiParams.propParams?.length > 0) {
        document.querySelector("#{{ .Params.id }} [data-params-section]").classList.remove("d-none")
        document.querySelector("#{{ .Params.id }} [data-props-section]").classList.remove("d-none")
        apiParams.propParams?.forEach((propParam) => {
          document.querySelector("#{{ .Params.id }} [data-props]").append(
            createKeyValuePair(
              "{{ .Params.id }}",
              propParam.key,
              propParam.value,
              propParam.placeholder
            )
          )
        })
      }

      // If Items Params, unhide & append key value pairs
      if (apiParams.itemsParams?.length > 0) {
        document.querySelector("#{{ .Params.id }} [data-params-section]").classList.remove("d-none")
        document.querySelector("#{{ .Params.id }} [data-items-section]").classList.remove("d-none")
        apiParams.itemsParams?.forEach((itemsParam) => {
          document.querySelector("#{{ .Params.id }} [data-items]").append(
            createKeyValuePair(
              "{{ .Params.id }}",
              itemsParam.key,
              itemsParam.value,
              itemsParam.placeholder
            )
          )
        })
      }

      // If Price Params, unhide & append key value pairs
      if (apiParams.priceParams?.length > 0) {
        document.querySelector("#{{ .Params.id }} [data-params-section]").classList.remove("d-none")
        document.querySelector("#{{ .Params.id }} [data-price-section]").classList.remove("d-none")
        apiParams.priceParams?.forEach((priceParam) => {
          document.querySelector("#{{ .Params.id }} [data-price]").append(
            createKeyValuePair(
              "{{ .Params.id }}",
              priceParam.key,
              priceParam.value,
              priceParam.placeholder
            )
          )
        })
      }

      // If Subscriptions Params, unhide & append key value pairs
      if (apiParams.subscriptionsParams?.length > 0) {
        document.querySelector("#{{ .Params.id }} [data-params-section]").classList.remove("d-none")
        document.querySelector("#{{ .Params.id }} [data-subscriptions-section]").classList.remove("d-none")
        apiParams.subscriptionsParams?.forEach((subscriptionsParam) => {
          document.querySelector("#{{ .Params.id }} [data-subscriptions]").append(
            createKeyValuePair(
              "{{ .Params.id }}",
              subscriptionsParam.key,
              subscriptionsParam.value,
              subscriptionsParam.placeholder
            )
          )
        })
      }

      // If JSON Params, unhide & set textContent
      if (typeof apiParams.jsonParams != "undefined") {
        // console.log("JSON PARAMS:", apiParams.jsonParams)
        jsonString = JSON.stringify(apiParams.jsonParams, null, 2)
        // console.log(jsonString)
        // console.log(jsonString.length)
        if (jsonString.length > 2) {
          document.querySelector("#{{ .Params.id }} [data-json-body]").textContent = jsonString
          document.querySelector("#{{ .Params.id }} [data-params-section]").classList.remove("d-none")
          document.querySelector("#{{ .Params.id }} [data-json-body-section]").classList.remove("d-none")

          // JSON Body Editor - Ace Code Editor for the Web
          editor = ace.edit(document.querySelector("#{{ .Params.id }} [data-json-body]"))
          editor.setTheme("ace/theme/monokai")
          editor.session.setMode("ace/mode/json")
          editor.setOptions({
            "maxLines": Infinity,
            "highlightActiveLine": false,
            "showLineNumbers": false,
            "showGutter": false,
            "showPrintMargin": false,
            "fontSize": 14
          })
        }
      }

      // Append header params key value pairs
      apiParams.headerParams?.forEach((headerParam) => {
        document.querySelector("#{{ .Params.id }} [data-request-headers]").append(
          createKeyValuePair(
            "{{ .Params.id }}",
            headerParam.key,
            headerParam.value,
            headerParam.placeholder
          )
        )
      })

      // If User Params, unhide & append key value pairs
      if (apiParams.userParams?.length > 0) {
        document.querySelector("#{{ .Params.id }} [data-user-section]").classList.remove("d-none")
        document.querySelector("#{{ .Params.id }} [data-user-params-section]").classList.remove("d-none")
        apiParams.userParams?.forEach((userParam) => {
          document.querySelector("#{{ .Params.id }} [data-user]").append(
            createKeyValuePair(
              "{{ .Params.id }}",
              userParam.key,
              userParam.value,
              userParam.placeholder
            )
          )
        })
      }

      // If Custom Identifier Params, unhide & append key value pairs
      if (apiParams.customParams?.length > 0) {
        document.querySelector("#{{ .Params.id }} [data-user-section]").classList.remove("d-none")
        document.querySelector("#{{ .Params.id }} [data-user-custom-section]").classList.remove("d-none")
        apiParams.customParams?.forEach((customParam) => {
          document.querySelector("#{{ .Params.id }} [data-user-custom]").append(
            createKeyValuePair(
              "{{ .Params.id }}",
              customParam.key,
              customParam.value,
              customParam.placeholder
            )
          )
        })
      }
      // If Source Params, unhide & append key value pairs
      if (apiParams.sourceParams?.length > 0) {
        document.querySelector("#{{ .Params.id }} [data-source-section]").classList.remove("d-none")
        apiParams.sourceParams?.forEach((sourceParam) => {
          document.querySelector("#{{ .Params.id }} [data-source]").append(
            createKeyValuePair(
              "{{ .Params.id }}",
              sourceParam.key,
              sourceParam.value,
              sourceParam.placeholder
            )
          )
        })
      }
    })


  let edsPayload = {}

  // Form Submit listener
  updatePayload = function (e) {

    let url = ''
    let method = ''
    let header_mapping = {}
    let params = {}
    let prop = {}
    let items = {}
    let price = {}
    let subscriptions = {}
    let user = {}
    let custom = {}
    let payload_mapping = {}
    let targetPayload = {}
    let source = {}
    let key_name = ''
    let extension = ''
    let sourcePayload = {}
    let clientPayload = {}

    // Set variable values from query selectors
    // Pass the id, the selector, and whether or not the value result should be enclosed in curly braces (true|false)
    url = document.querySelector("#{{ .Params.id }} [data-url]", false).value
    method = document.querySelector("#{{ .Params.id }} [data-method]", false).value
    header_mapping = keyValuePairsToObjects("{{ .Params.id }}", document.querySelector("#{{ .Params.id }} [data-request-headers]"), false).tempObject
    if (url.match("subscriptions")) {
      console.log("SUBSCRIPTIONS")
      console.log("curlyBraces OFF")
      params = keyValuePairsToObjects("{{ .Params.id }}", document.querySelector("#{{ .Params.id }} [data-query-params]"), false).tempObject
    } else {
      params = keyValuePairsToObjects("{{ .Params.id }}", document.querySelector("#{{ .Params.id }} [data-query-params]"), true).tempObject
    }
    prop = keyValuePairsToObjects("{{ .Params.id }}", document.querySelector("#{{ .Params.id }} [data-props]"), true).tempObject
    items = keyValuePairsToObjects("{{ .Params.id }}", document.querySelector("#{{ .Params.id }} [data-items]"), true).tempObject
    price = keyValuePairsToObjects("{{ .Params.id }}", document.querySelector("#{{ .Params.id }} [data-price]"), true).tempObject
    subscriptions = keyValuePairsToObjects("{{ .Params.id }}", document.querySelector("#{{ .Params.id }} [data-subscriptions]"), false).tempObject
    user = keyValuePairsToObjects("{{ .Params.id }}", document.querySelector("#{{ .Params.id }} [data-user]"), true).tempObject
    custom = keyValuePairsToObjects("{{ .Params.id }}", document.querySelector("#{{ .Params.id }} [data-user-custom]"), true).tempObject
    source = keyValuePairsToObjects("{{ .Params.id }}", document.querySelector("#{{ .Params.id }} [data-source]"), false).tempObject
    jsonBody = document.querySelector("#{{ .Params.id }} .ace_content")?.textContent
    // console.log("JSON BODY:", jsonBody)
    console.log("URL", url)
    // console.log("METHOD:", method)
    // console.log("HEADERS:", header_mapping)

    // console.log("PARAMS:", params)
    // Object.entries(params).forEach((entry) => {
    //   const [key, value] = entry
    //   console.log(`${key}: ${value}`)
    // })
    // if (params && Object.entries(params).length > 0) {
    //   Object.entries(params).forEach((entry) => {
    //     const [key, value] = entry
    //     payload_mapping[key] = value
    //   })
    // }

    // console.log("PARAMS:", params)
    if (params && Object.entries(params).length > 0) { payload_mapping = params } else {
      document.querySelector("#{{ .Params.id }} [data-query-params-section]").classList.add("d-none")
    }

    // console.log("PROP:", prop)
    if (prop && Object.entries(prop).length > 0) { payload_mapping.properties = prop } else {
      document.querySelector("#{{ .Params.id }} [data-props-section]").classList.add("d-none")
    }

    // console.log("ITEMS:", items)
    if (items && Object.entries(items).length > 0) { payload_mapping.items = [items] } else {
      document.querySelector("#{{ .Params.id }} [data-items-section]").classList.add("d-none")
    }

    // console.log("PRICE:", price)
    if (price && Object.entries(price).length > 0) { payload_mapping.items[0].price = [price] } else {
      document.querySelector("#{{ .Params.id }} [data-price-section]").classList.add("d-none")
    }

    // console.log("SUBSCRIPTIONS:", subscriptions)
    if (subscriptions && Object.entries(subscriptions).length > 0) { payload_mapping.subscriptions = [subscriptions] } else {
      document.querySelector("#{{ .Params.id }} [data-subscriptions-section]").classList.add("d-none")
    }

    // console.log("USER:", user)
    if (user && Object.entries(user).length > 0) { payload_mapping.user = user } else {
      document.querySelector("#{{ .Params.id }} [data-user-params-section]").classList.add("d-none")
    }

    // console.log("CUSTOM IDENTIFIER:", custom)
    if (custom && Object.entries(custom).length > 0) {
      payload_mapping.user.externalIdentifiers.custom = []
      payload_mapping.user.externalIdentifiers.custom[0] = custom
    } else {
      document.querySelector("#{{ .Params.id }} [data-user-custom-section]").classList.add("d-none")
    }

    console.log("PAYLOAD MAPPING", payload_mapping)

    targetPayload = {
      url,
      method,
      header_mapping,
      payload_mapping,
    }
    // console.log("TARGET PAYLOAD", targetPayload)

    sourcePayload = {
      "bucket_name": "solutions-sftp-bucket-prod",
      "options": {
        "match_prefix": true,
        "max_files": 1
      }
    }

    // console.log("SOURCE:", source)
    // console.log("SOURCE MAPPING BEFORE:", sourcePayload)

    // Concatenate source params
    if (source && Object.entries(source).length > 0) {
      if (source["clientName"]) clientPayload.clientName = source["clientName"]
      if (source["clientId"]) clientPayload.clientId = source["clientId"]
      if (source["fileName"]) key_name = `${source["fileName"].replace(/(\.\w*)/, '')}`
      // console.log("KEY_NAME:", key_name)
      if (source["dateFormat"]) key_name += `[[${source["dateFormat"]}]]`
      if (key_name && source["fileName"].match(/\.\w*/)) {
        extension = source["fileName"].match(/\.\w*/).toString()
        // console.log("EXTENSION", extension)
        key_name += extension
      }
      if (source["timeZone"]) key_name += `<&${source["timeZone"]}&>`
      sourcePayload.key_name = key_name
      if (source["delimiter"]) {
        delimiter = source["delimiter"]
        // console.log("DELIMITER:", delimiter)
        sourcePayload.delimiter = delimiter
      }
      // console.log("SOURCE PAYLOAD AFTER:", sourcePayload)
    }
    console.log("CLIENT PAYLOAD:", clientPayload)
    edsPayload.clientPayload = clientPayload
    console.log("TARGET PAYLOAD:", clientPayload)
    edsPayload.targetPayload = targetPayload
    console.log("SOURCE PAYLOAD:", sourcePayload)
    edsPayload.sourcePayload = sourcePayload
    console.log("EDS PAYLOAD:", edsPayload)


    updateTargetPayloadBody("{{ .Params.id }}", targetPayload)
    updateSourcePayloadBody("{{ .Params.id }}", sourcePayload)
  }

  // Add our event listeners
  window.addEventListener('DOMContentLoaded', updatePayload, false)
  document.querySelector("#{{ .Params.id }} [data-form]").addEventListener('keyup', updatePayload, false)
  document.querySelector("#{{ .Params.id }} [data-form]").addEventListener('click', updatePayload, false)


</script>